<!DOCTYPE html>
<html>
  <head>
    <title>OpenStreetMap</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
    />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <style>
      /* --- Incident Marker Styles --- */
      .incident-marker {
        border-radius: 50%;
        background-color: #2c3e50;
        width: 18px;
        height: 18px;
        border: 2px solid white;
      }

      .incident-marker.low {
        background-color: #ffffb2;
      }

      .incident-marker.medium {
        background-color: #fecc5c;
      }

      .incident-marker.high {
        background-color: #fd8d3c;
      }

      .incident-marker.critical {
        background-color: #e31a1c;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.3);
          opacity: 0.6;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      #map {
        height: 100vh;
        width: 100%;
      }
      body {
        margin: 0;
      }
      .incident-marker {
        width: 20px;
        height: 20px;
        background: red;
        border-radius: 50%;
      }
      .resource-marker {
        width: 20px;
        height: 20px;
        background: blue;
        border-radius: 50%;
      }
      .selected-marker {
        width: 20px;
        height: 20px;
        background: #4caf50;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      // Initialize map with doubleClickZoom disabled
      var map = L.map("map", {
        doubleClickZoom: false,
      }).setView([-1.286389, 36.817223], 6); // Center on Kenya

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "OpenStreetMap contributors",
      }).addTo(map);

      // Initialize layers
      var markers = L.markerClusterGroup({
        chunkedLoading: true,
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
      }).addTo(map);

      var heatLayer = L.heatLayer([], {
        radius: 25,
        blur: 15,
        maxZoom: 10,
        minOpacity: 0.4,
        gradient: {
          0.4: "#ffffb2",
          0.6: "#fecc5c",
          0.8: "#fd8d3c",
          1.0: "#e31a1c",
        },
      }).addTo(map);

      var alertCircles = L.layerGroup().addTo(map);
      var selectedMarker = null;
      window.selectionMode = false;

      // Store markers for management
      var incidentMarkers = [];
      var resourceMarkers = [];

      // Initialize web channel for Python communication
      new QWebChannel(qt.webChannelTransport, function (channel) {
        window.bridge = channel.objects.bridge;
        console.log("WebBridge connected to Python");

        // Notify Python that bridge is ready
        if (window.bridge && window.bridge.log_message) {
          window.bridge.log_message("Bridge connected");
        }
      });

      // Function to handle map clicks
      function onMapClick(e) {
        if (window.selectionMode) {
          // Prevent the default zoom behavior
          e.originalEvent.preventDefault();
          e.originalEvent.stopPropagation();

          // Remove existing selection marker
          if (selectedMarker) {
            markers.removeLayer(selectedMarker);
          }

          // Create a new marker at the clicked location
          selectedMarker = L.marker(e.latlng, {
            icon: L.divIcon({
              className: "selected-marker",
              html: "",
              iconSize: [20, 20],
            }),
          }).addTo(markers);

          // Notify Python about the selection
          if (window.bridge) {
            window.bridge.location_selected(e.latlng.lat, e.latlng.lng);
          }
        }
      }

      // Attach click handler
      map.on("click", onMapClick);

      // === UPDATED FUNCTIONS WITH CORRECT PARAMETERS ===

      // Function to clear all markers
      function clearMarkers() {
        markers.clearLayers();
        incidentMarkers = [];
        resourceMarkers = [];
        selectedMarker = null;
        console.log("All markers cleared");
      }

      // Function to add incident marker - UPDATED SIGNATURE
      function addIncidentMarker(lat, lng, title, severity, id) {
        console.log(`Adding incident marker: ${title} at ${lat}, ${lng}`);

        // Determine CSS class based on severity
        var severityClass = "incident-marker " + severity.toLowerCase();

        var marker = L.marker([lat, lng], {
          icon: L.divIcon({
            className: severityClass,
            html: "",
            iconSize: [20, 20],
          }),
        }).addTo(markers);

        // Store reference
        incidentMarkers.push(marker);

        // Create popup content
        var popupContent = `
      <div style="min-width: 200px;">
        <h3 style="margin: 0 0 10px 0; color: #2c3e50;">${title}</h3>
        <p><strong>Severity:</strong> <span style="color: ${getSeverityColor(
          severity
        )}">${severity}</span></p>
        <p><strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}</p>
        <button onclick="viewIncidentDetails('${id}')" 
                style="background: ${getSeverityColor(
                  severity
                )}; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-top: 5px;">
          View Details
        </button>
      </div>
    `;

        marker.bindPopup(popupContent);

        return true;
      }

      // Function to add resource marker - UPDATED SIGNATURE
      function addResourceMarker(lat, lng, title, type, status) {
        console.log(`Adding resource marker: ${title} at ${lat}, ${lng}`);

        var marker = L.marker([lat, lng], {
          icon: L.divIcon({
            className: "resource-marker",
            html: "",
            iconSize: [20, 20],
          }),
        }).addTo(markers);

        // Store reference
        resourceMarkers.push(marker);

        // Create popup content
        var popupContent = `
      <div style="min-width: 200px;">
        <h4 style="margin: 0 0 5px 0;">${title}</h4>
        <p><strong>Type:</strong> ${type}</p>
        <p><strong>Status:</strong> ${status}</p>
        <p><strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}</p>
      </div>
    `;

        marker.bindPopup(popupContent);

        return true;
      }

      // Helper function to get color based on severity
      function getSeverityColor(severity) {
        switch (severity.toLowerCase()) {
          case "critical":
            return "#e31a1c";
          case "high":
            return "#fd8d3c";
          case "medium":
            return "#fecc5c";
          case "low":
            return "#ffffb2";
          default:
            return "#2c3e50";
        }
      }

      // Function to handle incident details view
      function viewIncidentDetails(incidentId) {
        if (window.bridge && window.bridge.view_incident) {
          window.bridge.view_incident(incidentId);
        } else {
          console.log("Would view incident:", incidentId);
        }
      }

      // Function to set selection mode
      function setSelectionMode(enabled) {
        window.selectionMode = enabled;
        if (!enabled && selectedMarker) {
          markers.removeLayer(selectedMarker);
          selectedMarker = null;
        }
        // Disable zoom on click when in selection mode
        if (enabled) {
          map.scrollWheelZoom.disable();
        } else {
          map.scrollWheelZoom.enable();
        }
      }

      function toggleClustering(enabled) {
        map.removeLayer(markers);
        if (enabled) {
          markers = L.markerClusterGroup({
            chunkedLoading: true,
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
          });
        } else {
          markers = L.layerGroup();
        }
        map.addLayer(markers);
        // Re-add all existing markers
        refreshMarkers();
      }

      function updateHeatmap(points) {
        heatLayer.setLatLngs(points.map((p) => [p.lat, p.lng, p.intensity]));
      }

      function updateAlertRadius(lat, lng, radius, data) {
        // Remove existing circle for this location
        alertCircles.eachLayer((layer) => {
          if (layer.getLatLng().lat === lat && layer.getLatLng().lng === lng) {
            alertCircles.removeLayer(layer);
          }
        });

        if (radius > 0) {
          const circle = L.circle([lat, lng], {
            radius: radius,
            color: getAlertColor(data.severity),
            fillColor: getAlertColor(data.severity),
            fillOpacity: 0.2,
            weight: 1,
          }).bindPopup(`
                <b>${data.title}</b><br>
                Type: ${data.type}<br>
                Severity: ${data.severity}<br>
                Radius: ${radius / 1000}km
            `);
          alertCircles.addLayer(circle);
        }
      }

      function getAlertColor(severity) {
        switch (severity) {
          case "Critical":
            return "#e31a1c";
          case "High":
            return "#fd8d3c";
          case "Medium":
            return "#fecc5c";
          case "Low":
            return "#ffffb2";
          default:
            return "#808080";
        }
      }

      function refreshMarkers() {
        // Re-add all markers from current data
        incidentMarkers.forEach((marker) => {
          markers.addLayer(marker);
        });
        resourceMarkers.forEach((marker) => {
          markers.addLayer(marker);
        });
      }

      // Make functions globally available
      window.clearMarkers = clearMarkers;
      window.addIncidentMarker = addIncidentMarker;
      window.addResourceMarker = addResourceMarker;
      window.setSelectionMode = setSelectionMode;
      window.viewIncidentDetails = viewIncidentDetails;

      // Test that functions are available
      console.log("Map functions initialized:");
      console.log("- clearMarkers:", typeof clearMarkers);
      console.log("- addIncidentMarker:", typeof addIncidentMarker);
      console.log("- addResourceMarker:", typeof addResourceMarker);

      // Notify that map is ready
      if (window.bridge && window.bridge.log_message) {
        window.bridge.log_message("Kenya Disaster Map initialized");
      }
    </script>
  </body>
</html>
